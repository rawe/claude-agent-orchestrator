# Initiative: Session Identity and Runner Placement

## Overview

This initiative redesigns three interconnected aspects of the Agent Orchestrator:

1. **How sessions are identified** (ADR-010)
2. **How runs are matched to runners** (ADR-011)
3. **How runners are identified and registered** (ADR-012)

## Goals

- **Immediate session ID**: Get a session identifier at run creation, not after execution starts
- **Controlled placement**: Route runs to appropriate runners based on demands
- **Stable runner identity**: Recognize runner reconnections automatically
- **Executor abstraction**: Decouple session identity from executor-specific IDs
- **Remove session_name**: Eliminate dual-identity confusion and collision problems

## Architecture Decision Records

| ADR | Title | Summary |
|-----|-------|---------|
| [ADR-010](../adr/ADR-010-session-identity-and-executor-abstraction.md) | Session Identity and Executor Abstraction | Coordinator-generated `session_id`, `executor_session_id` as internal detail, session affinity for resume |
| [ADR-011](../adr/ADR-011-runner-capabilities-and-run-demands.md) | Runner Capabilities and Run Demands | Properties + capabilities on runners, demands on blueprints/runs, matching logic |
| [ADR-012](../adr/ADR-012-runner-identity-and-registration.md) | Runner Identity and Registration | Deterministic `runner_id` derivation, reconnection recognition, lifecycle management |

## Key Concepts

### Terminology

```
RUNNER
├── Properties (identity): hostname, project_dir, executor_type
├── Capabilities (features): tags
└── runner_id: Derived from properties by coordinator

SESSION
├── session_id: Generated by coordinator at run creation
├── executor_session_id: Framework's ID (Claude SDK, etc.)
└── Affinity: hostname + project_dir + executor_type (for resume)

DEMANDS
├── Property demands: hostname, project_dir, executor_type (exact match)
└── Capability demands: tags (must have ALL)
```

### Relationships

```
Blueprint defines base demands
         ↓
Run adds additional demands (additive only)
         ↓
Merged demands matched against runner properties/capabilities
         ↓
Matching runner claims run
         ↓
Session created, stores affinity info
         ↓
Resume must go to runner matching affinity
```

## Implementation Order

### Phase 1: Runner Identity (ADR-012) ✅ COMPLETE

**Why first:** Foundation for everything else. Runner properties must exist before we can match demands.

**Changes:**
- Runner registration: require hostname, project_dir, executor_type
- Coordinator derives runner_id deterministically from these properties
- Same properties = same runner_id (reconnection recognition)
- Lifecycle: online → stale (2 min) → removed (10 min)
- Background task for stale detection and cleanup

**Details:** See [phase-1-runner-identity.md](./phase-1-runner-identity.md)

### Phase 2: Runner Capabilities and Demands (ADR-011) ✅ COMPLETE

**Why second:** Builds on runner properties from Phase 1.

**Changes:**
- Runner registration: add `tags` array (capabilities)
- Agent blueprints: add `demands` section
- Run creation: add `additional_demands` (additive merge with blueprint)
- Claim logic: only matching runners can claim runs
- Timeout: runs fail after configurable timeout if no matching runner

**Details:** See [phase-2-demands.md](./phase-2-demands.md)

### Phase 3: Session Identity (ADR-010)

**Why last:** Depends on runner properties being established for session affinity.

**Changes:**
- Generate `session_id` at run creation (before execution)
- Return `session_id` in run creation response
- Remove `session_name` concept entirely
- Add `executor_session_id` field for framework's ID
- Add `POST /sessions/{session_id}/bind` endpoint (executor reports binding)
- Executor posts events using `session_id` (passed at startup)
- Resume uses `session_id`, coordinator enforces affinity
- Parent-child: `parent_session_id` instead of `parent_session_name`
- Update ao-* CLI commands to use session_id
- Update MCP server to use session_id

## Dependencies Between Phases

```
Phase 1 (Runner Identity)
    │
    │ Properties available for matching
    ▼
Phase 2 (Demands)
    │
    │ Matching ensures runs go to correct runners
    ▼
Phase 3 (Session Identity)
    │
    │ Session affinity uses same properties
    ▼
Complete system
```

## Out of Scope

- Soft/preferred demands
- Load-aware scheduling
- Resource demands (memory, CPU)
- Shared secret authentication for runners
- Geographic affinity
- Anti-affinity rules

## Success Criteria

- [x] Runner restarts get same runner_id
- [x] Runs with demands only go to matching runners
- [ ] session_id available immediately after run creation
- [ ] Resume works using session_id
- [ ] session_name completely removed
- [ ] Claude Code executor works with new model
- [ ] No regression in existing functionality

## References

- [ADR-010: Session Identity and Executor Abstraction](../adr/ADR-010-session-identity-and-executor-abstraction.md)
- [ADR-011: Runner Capabilities and Run Demands](../adr/ADR-011-runner-capabilities-and-run-demands.md)
- [ADR-012: Runner Identity and Registration](../adr/ADR-012-runner-identity-and-registration.md)
- [ARCHITECTURE.md](../ARCHITECTURE.md) - System overview