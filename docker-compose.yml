
services:
  # ============================================================================
  # UNIFIED FRONTEND (Agent Orchestrator UI)
  # ============================================================================
  frontend:
    container_name: agent-orchestrator-frontend
    build:
      context: ./agent-orchestrator-frontend
      dockerfile: Dockerfile
    ports:
      - "3000:80"
    environment:
      # These are baked in at build time via Vite
      - VITE_OBSERVABILITY_BACKEND_URL=http://localhost:8765
      - VITE_DOCUMENT_SERVER_URL=http://localhost:8766
      - VITE_AGENT_MANAGER_URL=http://localhost:8767
      - VITE_WEBSOCKET_URL=ws://localhost:8765/ws
    networks:
      - agent-orchestrator-network
    restart: unless-stopped
    depends_on:
      - agent-manager
      - observability-backend
      - context-store

  # ============================================================================
  # AGENT MANAGER BACKEND
  # ============================================================================
  agent-manager:
    container_name: agent-orchestrator-agent-manager
    build:
      context: ./agent-orchestrator-backend
      dockerfile: Dockerfile
    ports:
      - "8767:8767"
    volumes:
      - ./agent-orchestrator-backend:/app
      - ${AGENT_DIR:-./.agent-orchestrator/agents}:/data/agents
    environment:
      - PYTHONUNBUFFERED=1
      - AGENT_MANAGER_HOST=0.0.0.0
      - AGENT_MANAGER_PORT=8767
      - AGENT_ORCHESTRATOR_AGENTS_DIR=/data/agents
    networks:
      - agent-orchestrator-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "python", "-c", "import urllib.request; urllib.request.urlopen('http://localhost:8767/health')"]
      interval: 30s
      timeout: 3s
      retries: 3
      start_period: 5s

  # ============================================================================
  # OBSERVABILITY BACKEND
  # ============================================================================
  observability-backend:
    container_name: agent-orchestrator-observability-backend
    build:
      context: ./agent-orchestrator-observability
      dockerfile: docker/backend.Dockerfile
    ports:
      - "8765:8765"
    volumes:
      - ./agent-orchestrator-observability/backend:/app/backend
      - observability-data:/app/.agent-orchestrator
    environment:
      - PYTHONUNBUFFERED=1
      # Enable verbose debug logging for troubleshooting (set to true to enable)
      - DEBUG_LOGGING=false
    networks:
      - agent-orchestrator-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "python", "-c", "import urllib.request; urllib.request.urlopen('http://localhost:8765/sessions')"]
      interval: 30s
      timeout: 3s
      retries: 3
      start_period: 10s

  # ============================================================================
  # OBSERVABILITY FRONTEND (legacy - replaced by unified frontend)
  # ============================================================================
  # observability-frontend:
  #   container_name: agent-orchestrator-observability-frontend
  #   build:
  #     context: ./agent-orchestrator-observability
  #     dockerfile: docker/frontend.Dockerfile
  #   ports:
  #     - "5173:5173"
  #   volumes:
  #     - ./agent-orchestrator-observability/frontend/src:/app/src
  #     - ./agent-orchestrator-observability/frontend/index.html:/app/index.html
  #   environment:
  #     - VITE_BACKEND_URL=http://localhost:8765
  #   networks:
  #     - agent-orchestrator-network
  #   restart: unless-stopped
  #   depends_on:
  #     observability-backend:
  #       condition: service_healthy

  # ============================================================================
  # CONTEXT STORE
  # ============================================================================
  context-store:
    container_name: context-store
    build:
      context: ./servers/context-store
      dockerfile: Dockerfile
    ports:
      - "8766:8766"
    volumes:
      - document-data:/app/data
    environment:
      - DOCUMENT_SERVER_HOST=0.0.0.0
      - DOCUMENT_SERVER_PORT=8766
      - DOCUMENT_SERVER_STORAGE=/app/data/files
      - DOCUMENT_SERVER_DB=/app/data/documents.db
      # Public URL for generating document retrieval links
      # Change this if accessing from a different host/port or behind a proxy
      # Examples: "http://192.168.1.100:8766", "https://docs.example.com"
      - DOCUMENT_SERVER_PUBLIC_URL=http://localhost:8766
      - LOG_LEVEL=INFO
    networks:
      - agent-orchestrator-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "python", "-c", "import urllib.request; urllib.request.urlopen('http://localhost:8766/health')"]
      interval: 30s
      timeout: 3s
      retries: 3
      start_period: 5s

# ==============================================================================
# NETWORKS
# ==============================================================================
networks:
  agent-orchestrator-network:
    driver: bridge
    name: agent-orchestrator-network

# ==============================================================================
# VOLUMES
# ==============================================================================
volumes:
  document-data:
    name: agent-orchestrator-document-data
    driver: local
  observability-data:
    name: agent-orchestrator-observability-data
    driver: local
