
services:
  # ============================================================================
  # DASHBOARD (Agent Orchestrator UI)
  # ============================================================================
  dashboard:
    container_name: agent-orchestrator-dashboard
    build:
      context: ./dashboard
      dockerfile: Dockerfile
    ports:
      - "3000:80"
    environment:
      # These are baked in at build time via Vite
      - VITE_AGENT_ORCHESTRATOR_API_URL=http://localhost:8765
      - VITE_AGENT_CONTROL_API_URL=http://localhost:9500
      - VITE_DOCUMENT_SERVER_URL=http://localhost:8766
      - VITE_WEBSOCKET_URL=ws://localhost:8765/ws
    networks:
      - agent-orchestrator-network
    restart: unless-stopped
    depends_on:
      - agent-runtime
      - context-store

  # ============================================================================
  # AGENT RUNTIME (includes agent registry functionality)
  # ============================================================================
  agent-runtime:
    container_name: agent-orchestrator-agent-runtime
    build:
      context: ./servers/agent-runtime
      dockerfile: Dockerfile
    ports:
      - "8765:8765"
    volumes:
      - ./servers/agent-runtime:/app
      - runtime-data:/app/.agent-orchestrator
      - ${AGENT_DIR:-./config/agents}:/data/agents
    environment:
      - PYTHONUNBUFFERED=1
      # Enable verbose debug logging for troubleshooting (set to true to enable)
      - DEBUG_LOGGING=false
      - CORS_ORIGINS=*
      # Agent registry configuration (merged into runtime)
      - AGENT_ORCHESTRATOR_AGENTS_DIR=/data/agents
    networks:
      - agent-orchestrator-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "python", "-c", "import urllib.request; urllib.request.urlopen('http://localhost:8765/health')"]
      interval: 30s
      timeout: 3s
      retries: 3
      start_period: 10s

  # ============================================================================
  # CONTEXT STORE
  # ============================================================================
  context-store:
    container_name: context-store
    build:
      context: ./servers/context-store
      dockerfile: Dockerfile
    ports:
      - "8766:8766"
    volumes:
      - document-data:/app/data
    environment:
      - DOCUMENT_SERVER_HOST=0.0.0.0
      - DOCUMENT_SERVER_PORT=8766
      - DOCUMENT_SERVER_STORAGE=/app/data/files
      - DOCUMENT_SERVER_DB=/app/data/documents.db
      # Public URL for generating document retrieval links
      # Change this if accessing from a different host/port or behind a proxy
      # Examples: "http://192.168.1.100:8766", "https://docs.example.com"
      - DOCUMENT_SERVER_PUBLIC_URL=http://localhost:8766
      - LOG_LEVEL=INFO
      # CORS - allow all origins for browser extension support
      - CORS_ORIGINS=*
      # Semantic search settings (optional, disabled by default)
      - SEMANTIC_SEARCH_ENABLED=${SEMANTIC_SEARCH_ENABLED:-false}
      - OLLAMA_BASE_URL=${OLLAMA_BASE_URL:-http://host.docker.internal:11434}
      - OLLAMA_EMBEDDING_MODEL=${OLLAMA_EMBEDDING_MODEL:-nomic-embed-text}
      - ELASTICSEARCH_URL=http://elasticsearch:9200
      - ELASTICSEARCH_INDEX=${ELASTICSEARCH_INDEX:-context-store-vectors}
      - CHUNK_SIZE=${CHUNK_SIZE:-1000}
      - CHUNK_OVERLAP=${CHUNK_OVERLAP:-200}
    networks:
      - agent-orchestrator-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "python", "-c", "import urllib.request; urllib.request.urlopen('http://localhost:8766/health')"]
      interval: 30s
      timeout: 3s
      retries: 3
      start_period: 5s
    depends_on:
      elasticsearch:
        condition: service_healthy

  # ============================================================================
  # NEO4J (Graph Database)
  # ============================================================================
  neo4j:
    container_name: agent-orchestrator-neo4j
    image: neo4j:5-community
    ports:
      - "7475:7474"  # HTTP browser (offset to avoid Neo4j Desktop conflict)
      - "7688:7687"  # Bolt protocol (offset to avoid Neo4j Desktop conflict)
    volumes:
      - neo4j-data:/data
    environment:
      - NEO4J_AUTH=neo4j/agent-orchestrator
      - NEO4J_PLUGINS=["apoc"]
      # APOC configuration - required for apoc.meta.schema and other procedures
      - NEO4J_dbms_security_procedures_unrestricted=apoc.*
      - NEO4J_dbms_security_procedures_allowlist=apoc.*
    networks:
      - agent-orchestrator-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost:7474"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 30s

  # ============================================================================
  # ELASTICSEARCH (for semantic search)
  # ============================================================================
  elasticsearch:
    container_name: context-store-elasticsearch
    image: docker.elastic.co/elasticsearch/elasticsearch:8.11.0
    environment:
      - discovery.type=single-node
      - xpack.security.enabled=false
      - "ES_JAVA_OPTS=-Xms512m -Xmx512m"
    ports:
      - "9200:9200"
    volumes:
      - es-data:/usr/share/elasticsearch/data
    networks:
      - agent-orchestrator-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:9200/_cluster/health"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s

# ==============================================================================
# NETWORKS
# ==============================================================================
networks:
  agent-orchestrator-network:
    driver: bridge
    name: agent-orchestrator-network

# ==============================================================================
# VOLUMES
# ==============================================================================
volumes:
  document-data:
    name: agent-orchestrator-document-data
    driver: local
  runtime-data:
    name: agent-orchestrator-runtime-data
    driver: local
  es-data:
    name: context-store-es-data
    driver: local
  neo4j-data:
    name: agent-orchestrator-neo4j-data
    driver: local
