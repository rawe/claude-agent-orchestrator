
services:
  # ============================================================================
  # DASHBOARD (Agent Orchestrator UI)
  # ============================================================================
  dashboard:
    container_name: agent-orchestrator-dashboard
    build:
      context: ./dashboard
      dockerfile: Dockerfile
      # Vite env vars must be passed as build args (baked at build time)
      args:
        - VITE_AGENT_ORCHESTRATOR_API_URL=http://localhost:8765
        - VITE_DOCUMENT_SERVER_URL=http://localhost:8766
        # Auth0 OIDC (optional - see docs/guides/auth0-setup.md)
        - VITE_AUTH0_DOMAIN=${AUTH0_DOMAIN}
        - VITE_AUTH0_CLIENT_ID=${AUTH0_DASHBOARD_CLIENT_ID}
        - VITE_AUTH0_AUDIENCE=${AUTH0_AUDIENCE}
    ports:
      - "3000:80"
    networks:
      - agent-orchestrator-network
    restart: unless-stopped
    depends_on:
      - agent-coordinator
      - context-store

  # ============================================================================
  # AGENT COORDINATOR (includes agent registry functionality)
  # ============================================================================
  agent-coordinator:
    container_name: agent-orchestrator-agent-coordinator
    build:
      context: ./servers/agent-coordinator
      dockerfile: Dockerfile
    ports:
      - "8765:8765"
    volumes:
      - ./servers/agent-coordinator:/app
      - coordinator-data:/app/.agent-orchestrator
      - ${CONFIG_DIR:-./config}:/data/config
    environment:
      - PYTHONUNBUFFERED=1
      # Authentication (see docs/architecture/auth-coordinator.md)
      # Default false: docker-compose is for local development only
      - AUTH_ENABLED=${AUTH_ENABLED:-false}
      # Auth0 OIDC - required when AUTH_ENABLED=true
      # See docs/guides/auth0-setup.md for setup guide
      - AUTH0_DOMAIN=${AUTH0_DOMAIN}
      - AUTH0_AUDIENCE=${AUTH0_AUDIENCE}
      # Enable verbose debug logging for troubleshooting (set to true to enable)
      - DEBUG_LOGGING=false
      - CORS_ORIGINS=*
      # Agent registry configuration (merged into coordinator)
      - AGENT_ORCHESTRATOR_AGENTS_DIR=/data/config/agents
    networks:
      - agent-orchestrator-network
    restart: unless-stopped
    healthcheck:
      # Old HTTP-based check - no longer works because /health endpoint is secured
      # and we don't want to expose it without authentication.
      # test: ["CMD", "python", "-c", "import urllib.request; urllib.request.urlopen('http://localhost:8765/health')"]
      # New TCP-based check - verifies port is listening without requiring authentication
      test: ["CMD", "python", "-c", "import socket; s=socket.create_connection(('localhost', 8765), timeout=2); s.close()"]
      interval: 30s
      timeout: 3s
      retries: 3
      start_period: 10s

  # ============================================================================
  # CONTEXT STORE
  # ============================================================================
  context-store:
    container_name: context-store
    build:
      # Context is root directory to include both servers/context-store and mcps/context-store
      context: .
      dockerfile: servers/context-store/Dockerfile
    ports:
      - "8766:8766"
      - "9501:9501"  # MCP HTTP server
    volumes:
      - document-data:/app/data
    environment:
      - DOCUMENT_SERVER_HOST=0.0.0.0
      - DOCUMENT_SERVER_PORT=8766
      - DOCUMENT_SERVER_STORAGE=/app/data/files
      - DOCUMENT_SERVER_DB=/app/data/documents.db
      # Public URL for generating document retrieval links
      # Change this if accessing from a different host/port or behind a proxy
      # Examples: "http://192.168.1.100:8766", "https://docs.example.com"
      - DOCUMENT_SERVER_PUBLIC_URL=http://localhost:8766
      - LOG_LEVEL=INFO
      # CORS - allow all origins for browser extension support
      - CORS_ORIGINS=*
      # MCP HTTP server (enabled by default for development)
      - MCP_ENABLED=${MCP_ENABLED:-true}
      - MCP_HTTP_HOST=0.0.0.0
      - MCP_HTTP_PORT=9501
      # Semantic search settings (optional, disabled by default)
      - SEMANTIC_SEARCH_ENABLED=${SEMANTIC_SEARCH_ENABLED:-false}
      - OLLAMA_BASE_URL=${OLLAMA_BASE_URL:-http://host.docker.internal:11434}
      - OLLAMA_EMBEDDING_MODEL=${OLLAMA_EMBEDDING_MODEL:-nomic-embed-text}
      - ELASTICSEARCH_URL=http://elasticsearch:9200
      - ELASTICSEARCH_INDEX=${ELASTICSEARCH_INDEX:-context-store-vectors}
      - CHUNK_SIZE=${CHUNK_SIZE:-1000}
      - CHUNK_OVERLAP=${CHUNK_OVERLAP:-200}
    networks:
      - agent-orchestrator-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "python", "-c", "import urllib.request; urllib.request.urlopen('http://localhost:8766/health')"]
      interval: 30s
      timeout: 3s
      retries: 3
      start_period: 5s
    depends_on:
      elasticsearch:
        condition: service_healthy

  # ============================================================================
  # NEO4J (Graph Database)
  # ============================================================================
  neo4j:
    container_name: agent-orchestrator-neo4j
    image: neo4j:5-community
    ports:
      - "7475:7474"  # HTTP browser (offset to avoid Neo4j Desktop conflict)
      - "7688:7687"  # Bolt protocol (offset to avoid Neo4j Desktop conflict)
    volumes:
      - neo4j-data:/data
    environment:
      - NEO4J_AUTH=neo4j/agent-orchestrator
      - NEO4J_PLUGINS=["apoc"]
      # APOC configuration - required for apoc.meta.schema and other procedures
      - NEO4J_dbms_security_procedures_unrestricted=apoc.*
      - NEO4J_dbms_security_procedures_allowlist=apoc.*
    networks:
      - agent-orchestrator-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost:7474"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 30s

  # ============================================================================
  # AGENT RUNNER (Claude Code executor)
  # ============================================================================
  agent-runner:
    container_name: agent-orchestrator-agent-runner
    hostname: docker-claude-code-runner
    build:
      context: .
      dockerfile: servers/agent-runner/docker/Dockerfile
      target: claude-code
    environment:
      # REQUIRED: Claude Code OAuth token (generate with: claude setup-token)
      - CLAUDE_CODE_OAUTH_TOKEN=${CLAUDE_CODE_OAUTH_TOKEN}
      # Agent Coordinator URL (internal network)
      - AGENT_ORCHESTRATOR_API_URL=http://agent-coordinator:8765
      # Project directory inside container
      - PROJECT_DIR=/workspace
      # Executor profile
      - PROFILE=${AGENT_RUNNER_PROFILE:-best}
      # Optional settings
      - RUNNER_TAGS=${RUNNER_TAGS:-}
      - VERBOSE=${AGENT_RUNNER_VERBOSE:-false}
      # Auth0 M2M authentication (required when coordinator has AUTH_ENABLED=true)
      - AUTH0_DOMAIN=${AUTH0_DOMAIN}
      - AUTH0_AUDIENCE=${AUTH0_AUDIENCE}
      - AUTH0_RUNNER_CLIENT_ID=${AUTH0_RUNNER_CLIENT_ID}
      - AUTH0_RUNNER_CLIENT_SECRET=${AUTH0_RUNNER_CLIENT_SECRET}
    volumes:
      # WORKAROUND: Shared volume with agent-runner-procedural.
      # Both runners use the same workspace so that scripts referenced in
      # agent capabilities are accessible to autonomous agents (Claude Code).
      # Without this, scripts uploaded/managed by procedural agents wouldn't
      # be visible to Claude Code agents.
      - agent-runner-workspace:/workspace
    networks:
      - agent-orchestrator-network
    restart: unless-stopped
    depends_on:
      agent-coordinator:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "pgrep", "-f", "agent-runner"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

  # ============================================================================
  # AGENT RUNNER (Procedural executor)
  # ============================================================================
  agent-runner-procedural:
    container_name: agent-orchestrator-agent-runner-procedural
    hostname: docker-procedural-runner
    build:
      context: .
      dockerfile: servers/agent-runner/docker/Dockerfile
      target: procedural
    environment:
      # Agent Coordinator URL (internal network)
      - AGENT_ORCHESTRATOR_API_URL=http://agent-coordinator:8765
      # Project directory inside container
      - PROJECT_DIR=/workspace
      # Executor profile (echo is the default procedural test profile)
      - PROFILE=${PROCEDURAL_RUNNER_PROFILE:-echo}
      # Optional settings
      # Default tag 'uv' required for procedural scripts that use uv for Python execution
      - RUNNER_TAGS=${PROCEDURAL_RUNNER_TAGS:-uv}
      - VERBOSE=${AGENT_RUNNER_VERBOSE:-false}
      # Auth0 M2M authentication (required when coordinator has AUTH_ENABLED=true)
      - AUTH0_DOMAIN=${AUTH0_DOMAIN}
      - AUTH0_AUDIENCE=${AUTH0_AUDIENCE}
      - AUTH0_RUNNER_CLIENT_ID=${AUTH0_RUNNER_CLIENT_ID}
      - AUTH0_RUNNER_CLIENT_SECRET=${AUTH0_RUNNER_CLIENT_SECRET}
    volumes:
      # WORKAROUND: Shared volume with agent-runner (Claude Code).
      # Both runners use the same workspace so that scripts referenced in
      # agent capabilities are accessible to autonomous agents (Claude Code).
      # Without this, scripts uploaded/managed by procedural agents wouldn't
      # be visible to Claude Code agents.
      - agent-runner-workspace:/workspace
    networks:
      - agent-orchestrator-network
    restart: unless-stopped
    depends_on:
      agent-coordinator:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "pgrep", "-f", "agent-runner"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

  # ============================================================================
  # ELASTICSEARCH (for semantic search)
  # ============================================================================
  elasticsearch:
    container_name: context-store-elasticsearch
    image: docker.elastic.co/elasticsearch/elasticsearch:8.11.0
    environment:
      - discovery.type=single-node
      - xpack.security.enabled=false
      - "ES_JAVA_OPTS=-Xms512m -Xmx512m"
    ports:
      - "9200:9200"
    volumes:
      - es-data:/usr/share/elasticsearch/data
    networks:
      - agent-orchestrator-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:9200/_cluster/health"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s

# ==============================================================================
# NETWORKS
# ==============================================================================
networks:
  agent-orchestrator-network:
    driver: bridge
    name: agent-orchestrator-network

# ==============================================================================
# VOLUMES
# ==============================================================================
volumes:
  document-data:
    name: agent-orchestrator-document-data
    driver: local
  coordinator-data:
    name: agent-orchestrator-coordinator-data
    driver: local
  es-data:
    name: context-store-es-data
    driver: local
  neo4j-data:
    name: agent-orchestrator-neo4j-data
    driver: local
  agent-runner-workspace:
    name: agent-orchestrator-runner-workspace
    driver: local
