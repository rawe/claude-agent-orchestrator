
services:
  # ============================================================================
  # DASHBOARD (Agent Orchestrator UI)
  # ============================================================================
  dashboard:
    container_name: agent-orchestrator-dashboard
    build:
      context: ./dashboard
      dockerfile: Dockerfile
    ports:
      - "3000:80"
    environment:
      # These are baked in at build time via Vite
      - VITE_AGENT_RUNTIME_URL=http://localhost:8765
      - VITE_DOCUMENT_SERVER_URL=http://localhost:8766
      - VITE_AGENT_REGISTRY_URL=http://localhost:8767
      - VITE_WEBSOCKET_URL=ws://localhost:8765/ws
    networks:
      - agent-orchestrator-network
    restart: unless-stopped
    depends_on:
      - agent-registry
      - agent-runtime
      - context-store

  # ============================================================================
  # AGENT REGISTRY
  # ============================================================================
  agent-registry:
    container_name: agent-orchestrator-agent-registry
    build:
      context: ./servers/agent-registry
      dockerfile: Dockerfile
    ports:
      - "8767:8767"
    volumes:
      - ./servers/agent-registry:/app
      - ${AGENT_DIR:-./config/agents}:/data/agents
    environment:
      - PYTHONUNBUFFERED=1
      - AGENT_REGISTRY_HOST=0.0.0.0
      - AGENT_REGISTRY_PORT=8767
      - AGENT_ORCHESTRATOR_AGENTS_DIR=/data/agents
    networks:
      - agent-orchestrator-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "python", "-c", "import urllib.request; urllib.request.urlopen('http://localhost:8767/health')"]
      interval: 30s
      timeout: 3s
      retries: 3
      start_period: 5s

  # ============================================================================
  # AGENT RUNTIME
  # ============================================================================
  agent-runtime:
    container_name: agent-orchestrator-agent-runtime
    build:
      context: ./servers/agent-runtime
      dockerfile: Dockerfile
    ports:
      - "8765:8765"
    volumes:
      - ./servers/agent-runtime:/app
      - runtime-data:/app/.agent-orchestrator
    environment:
      - PYTHONUNBUFFERED=1
      # Enable verbose debug logging for troubleshooting (set to true to enable)
      - DEBUG_LOGGING=false
    networks:
      - agent-orchestrator-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "python", "-c", "import urllib.request; urllib.request.urlopen('http://localhost:8765/sessions')"]
      interval: 30s
      timeout: 3s
      retries: 3
      start_period: 10s

  # ============================================================================
  # CONTEXT STORE
  # ============================================================================
  context-store:
    container_name: context-store
    build:
      context: ./servers/context-store
      dockerfile: Dockerfile
    ports:
      - "8766:8766"
    volumes:
      - document-data:/app/data
    environment:
      - DOCUMENT_SERVER_HOST=0.0.0.0
      - DOCUMENT_SERVER_PORT=8766
      - DOCUMENT_SERVER_STORAGE=/app/data/files
      - DOCUMENT_SERVER_DB=/app/data/documents.db
      # Public URL for generating document retrieval links
      # Change this if accessing from a different host/port or behind a proxy
      # Examples: "http://192.168.1.100:8766", "https://docs.example.com"
      - DOCUMENT_SERVER_PUBLIC_URL=http://localhost:8766
      - LOG_LEVEL=INFO
    networks:
      - agent-orchestrator-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "python", "-c", "import urllib.request; urllib.request.urlopen('http://localhost:8766/health')"]
      interval: 30s
      timeout: 3s
      retries: 3
      start_period: 5s

# ==============================================================================
# NETWORKS
# ==============================================================================
networks:
  agent-orchestrator-network:
    driver: bridge
    name: agent-orchestrator-network

# ==============================================================================
# VOLUMES
# ==============================================================================
volumes:
  document-data:
    name: agent-orchestrator-document-data
    driver: local
  runtime-data:
    name: agent-orchestrator-runtime-data
    driver: local
