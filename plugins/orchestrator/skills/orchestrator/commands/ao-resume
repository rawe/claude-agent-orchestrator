#!/usr/bin/env -S uv run --script
# /// script
# requires-python = ">=3.11"
# dependencies = [
#     "claude-agent-sdk",
#     "typer",
#     "httpx",
# ]
# ///
"""
Resume an existing agent orchestrator session.

This command continues a previous session with a new prompt.

Configuration:
    AGENT_ORCHESTRATOR_AGENT_API_URL: API base URL (default: http://localhost:8767)
"""

import sys
from pathlib import Path

sys.path.insert(0, str(Path(__file__).parent / "lib"))

import typer
from typing import Optional

app = typer.Typer(add_completion=False)


@app.command()
def main(
    session_name: str = typer.Argument(..., help="Name of the session"),
    prompt: Optional[str] = typer.Option(None, "-p", "--prompt", help="Continuation prompt"),
    project_dir: Optional[Path] = typer.Option(None, "--project-dir", help="Project directory"),
):
    """
    Resume an existing agent orchestrator session.

    Examples:
        ao-resume mysession -p "Add error handling"
        cat additional-requirements.md | ao-resume mysession
    """
    from config import load_config
    from session import (
        validate_session_name,
        get_session_status,
        load_session_metadata,
        update_session_metadata,
    )
    from session_client import SessionClient, SessionClientError
    from agent_api import get_agent_api, AgentAPIError
    from claude_client import run_session_sync
    from utils import (
        get_prompt_from_args_and_stdin,
        log_command,
        log_result,
        error_exit,
        debug_log,
    )

    # DEBUG LOGGING - Command entry
    debug_log("COMMAND - ao-resume", {
        "cwd": str(Path.cwd()),
        "argv": sys.argv,
        "session_name": session_name,
        "prompt": prompt or "None (will read from stdin)",
        "project_dir": str(project_dir) if project_dir else "None",
    })

    try:
        # 1. Validate session name
        validate_session_name(session_name)

        # 2. Load configuration
        config = load_config(
            cli_project_dir=str(project_dir) if project_dir else None,
        )

        # 3. Check session exists and load metadata - try API first
        session_data = None
        try:
            client = SessionClient(config.session_manager_url)
            session_data = client.get_session_by_name(session_name)
        except SessionClientError as e:
            # API error, will try file fallback
            print(f"Warning: API error: {e}", file=sys.stderr)

        if session_data:
            # Use API data
            resume_session_id = session_data.get('session_id')
            session_project_dir = Path(session_data.get('project_dir', str(config.project_dir)))
            session_agent = session_data.get('agent_name')
        else:
            # Fallback to file-based
            status = get_session_status(session_name, config.sessions_dir)
            if status == "not_existent":
                error_exit(
                    f"Session '{session_name}' does not exist. "
                    "Use 'ao-new' command to create it"
                )
            metadata = load_session_metadata(session_name, config.sessions_dir)
            resume_session_id = metadata.session_id
            session_project_dir = metadata.project_dir
            session_agent = metadata.agent

        # 4. Context consistency validation
        # Warn if CLI overrides differ from session data (but don't fail)
        if project_dir and Path(project_dir).resolve() != session_project_dir:
            print(
                f"Warning: --project-dir override ignored. "
                f"Using session value: {session_project_dir}",
                file=sys.stderr,
            )

        # 5. Validate session_id exists
        if not resume_session_id:
            error_exit(
                f"Session '{session_name}' has no session_id. "
                "Cannot resume incomplete session"
            )

        # 7. Get prompt (from -p and/or stdin)
        user_prompt = get_prompt_from_args_and_stdin(prompt)

        # 6. Load agent MCP configuration from API if session has agent
        # NOTE: Do NOT prepend system prompt for resume (only for new sessions)
        mcp_servers = None

        if session_agent:
            try:
                agent_data = get_agent_api(session_agent)
            except AgentAPIError as e:
                error_exit(str(e))

            if not agent_data:
                error_exit(f"Agent not found: {session_agent}")

            if agent_data.get("status") == "inactive":
                error_exit(
                    f"Agent '{session_agent}' is inactive. "
                    "Cannot resume session with deactivated agent definition."
                )

            # Get MCP servers from API response
            mcp_servers = agent_data.get("mcp_servers")

        # 7. Log command (if logging enabled)
        if config.enable_logging:
            # Build command string for logging (similar to bash)
            mcp_info = f"with MCP servers: {list(mcp_servers.keys())}" if mcp_servers else "no MCP"
            full_command = (
                f"cd {session_project_dir} && "
                f"query(prompt=<prompt>, cwd={session_project_dir}, "
                f"permission_mode=bypassPermissions, resume={resume_session_id}, {mcp_info})"
            )
            log_command(
                session_name=session_name,
                command_type="resume",
                agent_name=session_agent,
                mcp_config_path=None,  # MCP config now comes from API
                full_command=full_command,
                prompt=user_prompt,
                sessions_dir=config.sessions_dir,
                project_dir=config.project_dir,
                agents_dir=config.agents_dir,
                enable_logging=config.enable_logging,
            )

        # 8. Run Claude session with resume
        session_file = config.sessions_dir / f"{session_name}.jsonl"

        session_id, result = run_session_sync(
            prompt=user_prompt,  # No system prompt prepended!
            session_file=session_file,
            project_dir=session_project_dir,
            session_name=session_name,
            sessions_dir=config.sessions_dir,
            mcp_servers=mcp_servers,
            resume_session_id=resume_session_id,  # KEY: Enable resume
            session_manager_url=config.session_manager_url,
            agent_name=session_agent,
        )

        # 11. Update session metadata timestamp
        update_session_metadata(session_name, config.sessions_dir)

        # 12. Log result (if logging enabled)
        if config.enable_logging:
            log_result(session_name, result, config.sessions_dir, config.enable_logging)

        # 13. Print result to stdout
        print(result)

    except ValueError as e:
        # Session validation errors, prompt errors, etc.
        error_exit(str(e))
    except FileNotFoundError as e:
        # Session not found, agent not found, etc.
        error_exit(str(e))
    except ImportError as e:
        # SDK not installed
        error_exit(
            f"Claude SDK not installed: {e}\n"
            "Install with: uv pip install claude-agent-sdk"
        )
    except Exception as e:
        # Unexpected errors (SDK errors, etc.)
        error_exit(f"Unexpected error: {e}")


if __name__ == "__main__":
    app()
