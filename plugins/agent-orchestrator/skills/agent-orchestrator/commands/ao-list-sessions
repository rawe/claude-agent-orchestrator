#!/usr/bin/env -S uv run --script
# /// script
# requires-python = ">=3.11"
# dependencies = [
#     "typer",
#     "httpx",
# ]
# ///
"""
List all agent orchestrator sessions with metadata.
"""

import sys
from pathlib import Path

sys.path.insert(0, str(Path(__file__).parent / "lib"))

import typer
from typing import Optional

app = typer.Typer(add_completion=False)


@app.command()
def main(
    project_dir: Optional[Path] = typer.Option(None, "--project-dir", help="Project directory"),
    sessions_dir: Optional[Path] = typer.Option(None, "--sessions-dir", help="Sessions directory"),
):
    """
    List all sessions with metadata.

    Displays: session name (session-id: session_id, project-dir: project_dir)

    Examples:
        ao-list-sessions
        ao-list-sessions --sessions-dir /custom/path
    """
    from config import load_config
    from session import list_all_sessions
    from session_client import SessionClient, SessionClientError
    from utils import debug_log

    # DEBUG LOGGING - Command entry
    debug_log("COMMAND - ao-list-sessions", {
        "cwd": str(Path.cwd()),
        "argv": sys.argv,
        "project_dir": str(project_dir) if project_dir else "None",
        "sessions_dir": str(sessions_dir) if sessions_dir else "None",
    })

    try:
        # Load configuration with CLI overrides
        config = load_config(
            cli_project_dir=str(project_dir) if project_dir else None,
            cli_sessions_dir=str(sessions_dir) if sessions_dir else None,
            cli_agents_dir=None,
        )

        # Try API first
        try:
            client = SessionClient(config.session_manager_url)
            sessions = client.list_sessions()
            if not sessions:
                print("No sessions found")
            else:
                for s in sessions:
                    print(f"{s.get('session_name', 'unknown')} (session-id: {s.get('session_id', 'unknown')}, project-dir: {s.get('project_dir', 'unknown')})")
            return
        except SessionClientError as e:
            # API error, fall back to file-based
            print(f"Warning: API error: {e}", file=sys.stderr)

        # Fallback to file-based
        sessions = list_all_sessions(config.sessions_dir)

        # Display results
        if not sessions:
            print("No sessions found")
        else:
            for session_name, session_id, project_dir_path in sessions:
                print(f"{session_name} (session-id: {session_id}, project-dir: {project_dir_path})")

    except Exception as e:
        # Handle errors
        print(f"Error: {e}", file=sys.stderr)
        raise typer.Exit(1)


if __name__ == "__main__":
    app()
