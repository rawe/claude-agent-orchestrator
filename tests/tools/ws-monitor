#!/usr/bin/env -S uv run --script
# /// script
# requires-python = ">=3.11"
# dependencies = [
#     "websockets",
# ]
# ///
"""
WebSocket Monitor - Connects to Agent Runtime WebSocket and prints events as JSON lines.

Usage:
    uv run tests/tools/ws-monitor

    # Or make executable
    chmod +x tests/tools/ws-monitor
    ./tests/tools/ws-monitor
"""

import asyncio
import json
import signal
import sys

# Configuration - modify these as needed
WS_URL = "ws://localhost:8765/ws"


async def monitor():
    """Connect to WebSocket and print all events."""
    import websockets

    print(f"Connecting to {WS_URL}...", file=sys.stderr)

    try:
        async with websockets.connect(WS_URL) as ws:
            print("Connected. Listening for events...", file=sys.stderr)
            print("---", file=sys.stderr)

            async for message in ws:
                # Print raw JSON line to stdout
                print(message, flush=True)

    except ConnectionRefusedError:
        print(f"Error: Could not connect to {WS_URL}", file=sys.stderr)
        print("Is the Agent Runtime running?", file=sys.stderr)
        sys.exit(1)
    except websockets.exceptions.ConnectionClosed:
        print("\nConnection closed.", file=sys.stderr)


def main():
    """Main entry point."""
    # Handle Ctrl+C gracefully
    def signal_handler(sig, frame):
        print("\nStopping monitor...", file=sys.stderr)
        sys.exit(0)

    signal.signal(signal.SIGINT, signal_handler)
    signal.signal(signal.SIGTERM, signal_handler)

    asyncio.run(monitor())


if __name__ == "__main__":
    main()
