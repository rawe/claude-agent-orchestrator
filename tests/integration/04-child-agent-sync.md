# Test: Child Agent (Sync Mode)

Verify that an orchestrator agent can spawn a child agent in synchronous mode (`mode=sync`).

**Note**: As of ADR-003, `parent_session_id` is always set for child sessions regardless of execution mode. The `execution_mode` field controls callback behavior, not the parent-child relationship.

## Prerequisites

- Agent Coordinator running
- Agent Runner running with `claude-code` executor
- sse-monitor running
- `agent-orchestrator` blueprint copied (see `tests/README.md` → "Agent Blueprints")

## Test Steps

### Step 1: Verify agent blueprint is available

```bash
curl -s http://localhost:8765/agents | python -m json.tool
```

Should include `agent-orchestrator` in the list.

### Step 2: Create orchestrator session

```bash
curl -X POST http://localhost:8765/runs \
  -H "Content-Type: application/json" \
  -d '{
    "type": "start_session",
    "agent_name": "agent-orchestrator",
    "prompt": "Start a child agent. The child should just say hello and exit.",
    "project_dir": "."
  }'
```

Expected response:
```json
{"run_id":"run_...","session_id":"ses_...","status":"pending"}
```

Note the `session_id` - this is the parent session.

### Step 3: Observe WebSocket events

Watch sse-monitor for:
1. Parent session events (the `session_id` from the response)
2. Child session events (new `session_id` generated by coordinator)

## Expected Events

### Parent Session Start
```json
{"type": "session_created", "session": {"session_id": "ses_...", "agent_name": "agent-orchestrator", ...}}
```

### Child Session Created
```json
{"type": "session_created", "session": {"session_id": "ses_<child>", "parent_session_id": "ses_<parent>", ...}}
```

Note: The child session has `parent_session_id` set to the parent's `session_id`.

### Child Session Complete
```json
{"type": "event", "data": {"event_type": "session_stop", "session_id": "ses_<child>", "exit_code": 0, ...}}
```

## Verification Checklist

- [ ] Parent session created with `agent_name: "agent-orchestrator"`
- [ ] Child session created with `parent_session_id` set to parent's `session_id`
- [ ] Both `session_id` values follow format `ses_...`
- [ ] Child session completes successfully
- [ ] Parent session completes successfully

## Troubleshooting

### MCP server not reachable
- The MCP server is embedded in the Agent Runner - ensure the runner is running
- Check the runner logs for the MCP server port (assigned dynamically or via `--mcp-port`)
- Verify the `agent.mcp.json` uses `${AGENT_ORCHESTRATOR_MCP_URL}` placeholder (replaced at runtime)

### Agent blueprint not found
- Verify blueprint is copied (see `tests/README.md` → "Agent Blueprints")
- Check coordinator logs for agent loading errors

### Child agent not starting
- Check MCP server logs for errors
- Verify `AGENT_SESSION_ID` header is passed correctly (replaces `${AGENT_SESSION_ID}`)
