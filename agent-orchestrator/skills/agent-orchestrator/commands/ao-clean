#!/usr/bin/env -S uv run --script
# /// script
# requires-python = ">=3.11"
# dependencies = [
#     "typer",
#     "httpx",
# ]
# ///
"""
Remove all agent orchestrator sessions.
"""

import sys
from pathlib import Path

sys.path.insert(0, str(Path(__file__).parent / "lib"))

import typer
from typing import Optional
import httpx

app = typer.Typer(add_completion=False)


def delete_from_observability(session_id: str, observability_url: str) -> bool:
    """
    Delete session from observability backend.

    Returns True if successful or session not found, False on error.
    """
    try:
        response = httpx.delete(
            f"{observability_url}/sessions/{session_id}",
            timeout=2.0
        )
        # 200 = deleted, 404 = not found (both OK)
        return response.status_code in (200, 404)
    except Exception:
        # Silent failure - don't block cleanup
        return False


@app.command()
def main(
    project_dir: Optional[Path] = typer.Option(None, "--project-dir", help="Project directory"),
    sessions_dir: Optional[Path] = typer.Option(None, "--sessions-dir", help="Sessions directory"),
):
    """
    Remove all sessions.

    Examples:
        ao-clean
        ao-clean --sessions-dir /custom/path
    """
    from config import load_config
    from session import list_all_sessions
    import shutil

    try:
        # Load configuration with CLI overrides
        config = load_config(
            cli_project_dir=str(project_dir) if project_dir else None,
            cli_sessions_dir=str(sessions_dir) if sessions_dir else None,
            cli_agents_dir=None,
        )

        # Check if sessions directory exists
        if config.sessions_dir.exists():
            # Delete from observability if enabled
            if config.observability_enabled:
                try:
                    sessions = list_all_sessions(config.sessions_dir)
                    for session_name, session_id, project_dir_path in sessions:
                        if session_id and session_id != "unknown":
                            delete_from_observability(
                                session_id,
                                config.observability_url
                            )
                except Exception:
                    # Ignore errors - sessions might not exist or be incomplete
                    pass

            # Remove entire directory
            shutil.rmtree(config.sessions_dir)
            print("All sessions removed")
        else:
            print("No sessions to remove")

    except Exception as e:
        print(f"Error: {e}", file=sys.stderr)
        raise typer.Exit(1)


if __name__ == "__main__":
    app()
